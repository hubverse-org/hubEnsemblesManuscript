<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Li Shandross, Emily Howerton, Lucie Contamin, Harry Hochheiser, Anna Krystalli, Consortium of Infectious Disease Modeling Hubs, Nicholas G. Reich, and Evan L. Ray">
<meta name="keywords" content="<p>multiple models; aggregation; forecast; prediction</p>">

<title>hubEnsembles: Ensembling Methods in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="hubEnsembles_manuscript_files/libs/clipboard/clipboard.min.js"></script>
<script src="hubEnsembles_manuscript_files/libs/quarto-html/quarto.js"></script>
<script src="hubEnsembles_manuscript_files/libs/quarto-html/popper.min.js"></script>
<script src="hubEnsembles_manuscript_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hubEnsembles_manuscript_files/libs/quarto-html/anchor.min.js"></script>
<link href="hubEnsembles_manuscript_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hubEnsembles_manuscript_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hubEnsembles_manuscript_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hubEnsembles_manuscript_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hubEnsembles_manuscript_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="hubEnsembles_manuscript_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="hubEnsembles_manuscript_files/libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><code>hubEnsembles</code>: Ensembling Methods in R</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Li Shandross <a href="mailto:lshandross@umass.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0009-0008-1348-1954" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Massachusetts Amherst
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Emily Howerton <a href="https://orcid.org/0000-0002-0639-3728" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Pennsylvania State University
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Lucie Contamin <a href="https://orcid.org/0000-0001-5797-1279" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pittsburgh
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Harry Hochheiser <a href="https://orcid.org/0000-0001-8793-9982" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pittsburgh
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Anna Krystalli <a href="https://orcid.org/0000-0002-2378-4915" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            R-RSE SMPC
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Consortium of Infectious Disease Modeling Hubs </p>
  </div>
  <div class="quarto-title-meta-contents">
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Nicholas G. Reich <a href="https://orcid.org/0000-0003-3503-9899" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Massachusetts Amherst
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Evan L. Ray <a href="https://orcid.org/0000-0003-4035-0243" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Massachusetts Amherst
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>Given the demonstrated performance improvements of multi-model ensembles, combining predictions from multiple models is a common practice across many fields. The R package <code>hubEnsembles</code> provides a flexible framework for ensembling various types of predictions, including point estimates and probabilistic predictions. A range of common methods for generating ensembles are supported, including weighted averages, quantile averages, and linear pools. The <code>hubEnsembles</code> package fits within a broader framework of open-source software and data tools called the “hubverse”, which facilitates the development and management of collaborative modelling exercises.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p></p><p>multiple models; aggregation; forecast; prediction</p><p></p>
  </div>
</div>

</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Predictions of future outcomes are essential to planning and decision making, yet generating reliable predictions of the future is challenging. One method for overcoming this challenge is combining predictions across multiple, independent models. These combination methods (also called aggregation or ensembling) have been repeatedly shown to produce predictions that are more accurate <span class="citation" data-cites="clemen1989 timmermann2006b">(<a href="#ref-clemen1989" role="doc-biblioref">Clemen 1989</a>; <a href="#ref-timmermann2006b" role="doc-biblioref">Timmermann 2006</a>)</span> and more consistent <span class="citation" data-cites="hibon2005">(<a href="#ref-hibon2005" role="doc-biblioref">Hibon and Evgeniou 2005</a>)</span> than individual models. Because of the clear performance benefits, multi-model ensembles are commonplace across fields, including weather <span class="citation" data-cites="alley2019">(<a href="#ref-alley2019" role="doc-biblioref">Alley, Emanuel, and Zhang 2019</a>)</span>, climate <span class="citation" data-cites="tebaldi2007">(<a href="#ref-tebaldi2007" role="doc-biblioref">Tebaldi and Knutti 2007</a>)</span>, and economics <span class="citation" data-cites="aastveit2018">(<a href="#ref-aastveit2018" role="doc-biblioref">Aastveit et al. 2018</a>)</span>. More recently, multi-model ensembles have been used to improve predictions of infectious disease outbreaks <span class="citation" data-cites="viboud2018 johansson2019 mcgowan2019 reich_accuracy_2019 cramer2022">(<a href="#ref-viboud2018" role="doc-biblioref">Viboud et al. 2018</a>; <a href="#ref-johansson2019" role="doc-biblioref">Johansson et al. 2019</a>; <a href="#ref-mcgowan2019" role="doc-biblioref">McGowan et al. 2019</a>; <a href="#ref-reich_accuracy_2019" role="doc-biblioref">Reich et al. 2019</a>; <a href="#ref-cramer2022" role="doc-biblioref">Cramer et al. 2022</a>)</span>.</p>
<p>In the rapidly growing field of outbreak forecasting, there are many proposed methods for generating ensembles. Generally, these methods differ in at least one of two ways: (1) the function used to combine or “average” predictions, and (2) how predictions are weighted when performing the combination. No one method is universally “the best”; a simple average of predictions works surprisingly well across a range of settings <span class="citation" data-cites="mcgowan2019 paireau_ensemble_2022 ray_comparing_2023">(<a href="#ref-mcgowan2019" role="doc-biblioref">McGowan et al. 2019</a>; <a href="#ref-paireau_ensemble_2022" role="doc-biblioref">Paireau et al. 2022</a>; <a href="#ref-ray_comparing_2023" role="doc-biblioref">Ray et al. 2023</a>)</span> for established theoretical reasons <span class="citation" data-cites="winkler2015">(<a href="#ref-winkler2015" role="doc-biblioref">Winkler 2015</a>)</span>. However, more complex approaches have also been shown to have benefits in some settings <span class="citation" data-cites="yamana_superensemble_2016 ray_prediction_2018 reich_accuracy_2019 colon-gonzalez_probabilistic_2021">(<a href="#ref-yamana_superensemble_2016" role="doc-biblioref">Yamana, Kandula, and Shaman 2016</a>; <a href="#ref-ray_prediction_2018" role="doc-biblioref">Ray and Reich 2018</a>; <a href="#ref-reich_accuracy_2019" role="doc-biblioref">Reich et al. 2019</a>; <a href="#ref-colon-gonzalez_probabilistic_2021" role="doc-biblioref">Colón-González et al. 2021</a>)</span>. Here, we present the <code>hubEnsembles</code> package, which provides a flexible framework for generating ensemble predictions from multiple models. Complementing other software for combining predictions from multiple models (e.g., <span class="citation" data-cites="pedregosa_scikit-learn_2011 weiss2019 bosse_stackr_2023 couch_stacks_2023">(<a href="#ref-pedregosa_scikit-learn_2011" role="doc-biblioref">Pedregosa et al. 2011</a>; <a href="#ref-weiss2019" role="doc-biblioref">Weiss, Raviv, and Roetzer 2019</a>; <a href="#ref-bosse_stackr_2023" role="doc-biblioref">Bosse et al. 2023</a>; <a href="#ref-couch_stacks_2023" role="doc-biblioref">Couch and Kuhn 2023</a>)</span>), <code>hubEnsembles</code> supports multiple types of predictions, including point estimates and different kinds of probabilistic predictions. Throughout, we will use the term “prediction” to refer to any kind of model output that may be combined including a forecast, a scenario projection, or a parameter estimate.</p>
<p>The <code>hubEnsembles</code> package is part of the “hubverse” collection of open-source software and data tools. The hubverse project facilitates the development and management of collaborative modelling exercises (<a href="https://hubdocs.readthedocs.io/en/latest/index.html" class="uri">https://hubdocs.readthedocs.io/en/latest/index.html</a>). The broader hubverse initiative is motivated by the demonstrated benefits of collaborative hubs <span class="citation" data-cites="reich2022 borchering_public_2023">(<a href="#ref-reich2022" role="doc-biblioref">Reich et al. 2022</a>; <a href="#ref-borchering_public_2023" role="doc-biblioref">Borchering et al. 2023</a>)</span>, including performance benefits of multi-model ensembles and the desire for standardization across such hubs. In this paper, we focus specifically on the functionality encompassed in <code>hubEnsembles</code>. We provide an overview of the methods implemented, including mathematical definitions and properties (<a href="#sec-defs" class="quarto-xref">Section&nbsp;2</a>) as well as implementation details (<a href="#sec-implementation" class="quarto-xref">Section&nbsp;3</a>); we give simple examples to demonstrate the functionality (<a href="#sec-simple-ex" class="quarto-xref">Section&nbsp;4</a>) and a more complex case study (<a href="#sec-flu" class="quarto-xref">Section&nbsp;5</a>) that motivates a discussion and comparison of the various methods (<a href="#sec-conclusions" class="quarto-xref">Section&nbsp;6</a>).</p>
</section>
<section id="sec-defs" class="level1">
<h1>Mathematical definitions and properties of ensemble methods</h1>
<p>The <code>hubEnsembles</code> package supports both point predictions and probabilistic predictions of different formats. A point prediction gives a single estimate of a future outcome while a probabilistic prediction provides an estimated probability distribution over a future outcome. We use <span class="math inline">\(N\)</span> to denote the total number of individual predictions that the ensemble will combine. For example, these predictions will often be produced by different statistical or mathematical models, and <span class="math inline">\(N\)</span> is the total number of models that have provided predictions. Individual predictions will be indexed by the subscript <span class="math inline">\(i\)</span>. Optionally, the package allows for calculating ensembles that use a weight <span class="math inline">\(w_i\)</span> for each prediction; we define the set of model-specific weights as <span class="math inline">\(\pmb{w} = \{w_i | i \in 1, ..., N\}\)</span>. Informally, predictions with a larger weight have a greater influence on the value of the ensemble prediction, though the details of this depend on the ensemble method (described further below).</p>
<p>For a set of <span class="math inline">\(N\)</span> point predictions, <span class="math inline">\(\pmb{p} = \{p_i|i \in 1, ..., N\}\)</span>, each from a distinct model <span class="math inline">\(i\)</span>, the <code>hubEnsembles</code> package can compute an ensemble of these predictions</p>
<p><span class="math display">\[
p_E = C(\pmb{p}, \pmb{w})
\]</span></p>
<p>using any function <span class="math inline">\(C\)</span>, and a any set of model-specific weights <span class="math inline">\(\pmb{w}\)</span>. For example, an arithmetic average of predictions yields <span class="math inline">\(p_E = \sum_{i=1}^Np_iw_i\)</span>, where the weights are non-negative and sum to 1. If <span class="math inline">\(w_i = 1/N\)</span> for all <span class="math inline">\(i\)</span>, all predictions will be equally weighted. This framework can also support more complex functions for aggregation, such as a (weighted) median or geometric mean.</p>
<p>For probabilistic predictions, there are two commonly used classes of methods to average or ensemble multiple predictions: quantile averaging (also called a Vincent average <span class="citation" data-cites="vincent1912">(<a href="#ref-vincent1912" role="doc-biblioref">Vincent 1912</a>)</span>) and probability averaging (also called a distributional mixture or linear opinion pool <span class="citation" data-cites="stone1961">(<a href="#ref-stone1961" role="doc-biblioref">Stone 1961</a>)</span>) <span class="citation" data-cites="lichtendahl2013">(<a href="#ref-lichtendahl2013" role="doc-biblioref">Lichtendahl, Grushka-Cockayne, and Winkler 2013</a>)</span>. To define these two classes of methods, let <span class="math inline">\(F(x)\)</span> be a cumulative density function (CDF) defined over values <span class="math inline">\(x\)</span> of the target variable for the prediction, and <span class="math inline">\(F^{-1}(\theta)\)</span> be the corresponding quantile function defined over quantile levels <span class="math inline">\(\theta \in [0, 1]\)</span>. Throughout this article, we may refer to <span class="math inline">\(x\)</span> as either a ‘value of the target variable’ or a ‘quantile’ depending on the context, and similarly we may refer to <span class="math inline">\(\theta\)</span> as either a ‘quantile level’ or a ‘(cumulative) probability’. Additionally, we will use <span class="math inline">\(f(x)\)</span> to denote a probability mass function (PMF) for a prediction of a discrete variable or a discretization (such as binned values) of a continuous variable.</p>
<p>The quantile average combines a set of quantile functions, <span class="math inline">\(\mathcal{Q} = \{F_i^{-1}(\theta)| i \in 1,...,N \}\)</span>, with a given set of weights, <span class="math inline">\(\pmb{w}\)</span>, as <span class="math display">\[
F^{-1}_Q(\theta) = C_Q(\mathcal{Q}, \pmb{w}) = \sum_{i = 1}^Nw_iF^{-1}_i(\theta).
\]</span>This computes the average value of predictions across different models for each fixed quantile level <span class="math inline">\(\theta\)</span>. It is also possible to use other combination functions, such as a weighted median, to combine quantile predictions.</p>
<p>The probability average or linear pool is calculated by averaging probabilities across predictions for a fixed value of the target variable, <span class="math inline">\(x\)</span>. In other words, for a set of CDFs, <span class="math inline">\(\mathcal{F} = \{F_i(x)| i \in 1,...,N \}\)</span> and weights, <span class="math inline">\(\pmb{w}\)</span>, the linear pool is calculated as</p>
<p><span class="math display">\[
F_{LOP}(x) = C_{LOP}(\mathcal{F}, \pmb{w}) = \sum_{i = 1}^Nw_iF_i(x).
\]</span> For a set of PMFs, <span class="math inline">\(\{f_i|i \in 1, ..., N\}\)</span>, the linear pool can be equivalently calculated: <span class="math inline">\(f_{LOP}(x) = \sum_{i = 1}^N w_i f_i(x)\)</span>.</p>
<p>The different averaging methods for probabilistic predictions yield different properties of the resulting ensemble distribution. For example, the variance of the linear pool is <span class="math inline">\(\sigma^2_{LOP} = \sum_{i=1}^Nw_i\sigma_i^2 + \sum_{i=1}^Nw_i(\mu_i-\mu_{LOP})^2\)</span>, where <span class="math inline">\(\mu_i\)</span> is the mean and <span class="math inline">\(\sigma^2_i\)</span> is the variance of individual prediction <span class="math inline">\(i\)</span>, and although there is no closed-form variance for the quantile average, the variance of the quantile average will always be less than or equal to that of the linear pool <span class="citation" data-cites="lichtendahl2013">(<a href="#ref-lichtendahl2013" role="doc-biblioref">Lichtendahl, Grushka-Cockayne, and Winkler 2013</a>)</span>. Both methods generate distributions with the same mean, <span class="math inline">\(\mu_Q = \mu_{LOP} = \sum_{i=1}^Nw_i\mu_i\)</span>, which is the mean of individual model means <span class="citation" data-cites="lichtendahl2013">(<a href="#ref-lichtendahl2013" role="doc-biblioref">Lichtendahl, Grushka-Cockayne, and Winkler 2013</a>)</span>. The linear pool method preserves variation between individual models, whereas the quantile average cancels away this variation under the assumption it constitutes sampling error <span class="citation" data-cites="howerton2023">(<a href="#ref-howerton2023" role="doc-biblioref">Howerton et al. 2023</a>)</span>.</p>
</section>
<section id="sec-implementation" class="level1">
<h1>Model implementation details</h1>
<p>To understand how these methods are implemented in <code>hubEnsembles</code>, we first must define the conventions employed by the hubverse and its packages for representing and working with model predictions. We begin with a short overview of concepts and conventions needed to utilize the <code>hubEnsembles</code> package, then explain the implementation of the two ensembling functions provided by the package, <code>simple_ensemble</code> and <code>linear_pool</code>.</p>
<section id="hubverse-terminology-and-conventions" class="level2">
<h2 class="anchored" data-anchor-id="hubverse-terminology-and-conventions">Hubverse terminology and conventions</h2>
<p>A central concept in the hubverse effort is “model output”. Model output is a specially formatted tabular representation of predictions. Each row represents a single, unique prediction with each column providing information about what is being predicted, its scope, and its value. Per hubverse convention, each column serves one of three purposes: denote which model has produced the prediction (called the “model ID”), provide details about what is being predicted (called the “task IDs”), or specify how the prediction is represented (called the “model output representation”) <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.</p>
<p>Predictions are assumed to be generated by distinct models, typically developed and run by a modeling team of one or more individuals. Each model should have a unique identifier that is stored in the <code>model_id</code> column.</p>
<p>Then, the details of the outcome being predicted can be stored in a series of task ID columns. These task ID columns may also include additional information, such as any conditions or assumptions that were used to generate the predictions <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>. For example, short-term forecasts of incident influenza hospitalizations in the US at different locations and amounts of time in the future (<a href="#tbl-flu-forecasts" class="quarto-xref">Table&nbsp;1</a>) might represent this information using a <code>target</code> column with the value “wk ahead inc flu hosp”, a <code>location</code> column identifying the location being predicted, a <code>reference_date</code> column with the “starting point” of the forecasts, and a <code>horizon</code> column with the number of steps ahead that the forecast is predicting relative to the <code>reference_date</code>. All these variables make up the task ID columns <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.</p>
<div class="cell">
<div id="tbl-flu-forecasts" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-flu-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Example of forecasts for weekly incident flu hospitalizations, formatted according to hubverse standards. Quantile forecasts for the median and 50%, 80%, and 98% prediction intervals are shown.
</figcaption>
<div aria-describedby="tbl-flu-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 13%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model_id</th>
<th style="text-align: left;">target</th>
<th style="text-align: left;">location</th>
<th style="text-align: left;">reference_date</th>
<th style="text-align: right;">horizon</th>
<th style="text-align: left;">output_type</th>
<th style="text-align: right;">output_type_id</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">766</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">850</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">913</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">1010</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">1077</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">1153</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">1281</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Alternatively, longer-term scenario projections for cumulative COVID-19 deaths in the US at different locations, amounts of time in the future, and under different assumed conditions may use the following task ID columns: a <code>target</code> of “cum death”, a <code>location</code> column specifying the location being predicted, an <code>origin_date</code> on which the projections were made, a <code>horizon</code> describing the number of steps ahead that the projection is predicting relative to the <code>origin_date</code>, and a <code>scenario_id</code> denoting the future conditions that were modeled and are projected to result in the specified number of cumulative deaths (<a href="#tbl-example-scenarios" class="quarto-xref">Table&nbsp;2</a>). Different modeling efforts may use different sets of task ID columns and values to specify their prediction goals. Additional examples of task ID variables are available on the hubverse documentation website (<a href="https://hubdocs.readthedocs.io/en/latest/user-guide/tasks.html" class="uri">https://hubdocs.readthedocs.io/en/latest/user-guide/tasks.html</a>).</p>
<div class="cell">
<div id="tbl-example-scenarios" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Example of scenario projections for cumulative COVID-19 deaths, formatted according to hubverse standards. Quantile predictions for the median and 50% prediction intervals are shown for four distinct scenarios. This example is a subset of the <code>example-complex-scenario-hub</code> data provided by the hubverse <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.
</figcaption>
<div aria-describedby="tbl-example-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model_id</th>
<th style="text-align: left;">target</th>
<th style="text-align: left;">location</th>
<th style="text-align: left;">origin_date</th>
<th style="text-align: right;">horizon</th>
<th style="text-align: left;">scenario_id</th>
<th style="text-align: left;">output_type</th>
<th style="text-align: right;">output_type_id</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">A-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">571104.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">A-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">574478.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">A-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">578958.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">B-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">579960.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">B-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">584210.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">B-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">588643.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">C-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">630991.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">C-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">640293.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">C-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">650513.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">D-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">675736.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">D-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">688469.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">HUBuni-simexamp</td>
<td style="text-align: left;">cum death</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">2021-03-07</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">D-2021-03-05</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">700861.5</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The model output representation includes the predicted values along with metadata that specifies how the predictions are conveyed, and consists of three columns: (1) <code>output_type</code>, (2) <code>output_type_id</code>, and (3) <code>value</code>. Unlike for the task IDs, these three columns are required and their names are fixed <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>. The <code>output_type</code> defines how the prediction is represented and may be one of <code>"mean"</code> or <code>"median"</code> (point prediction), <code>"quantile"</code>, <code>"cdf"</code>, <code>"pmf"</code> (distributional prediction), or <code>"sample"</code> (although this output type is not yet supported by the <code>hubEnsembles</code> package). The <code>output_type_id</code> provides more identifying information for a prediction and is specific to the particular <code>output_type</code> (see <a href="#tbl-flu-forecasts" class="quarto-xref">Table&nbsp;1</a>). For quantile predictions, the <code>output_type_id</code> is a numeric value between 0 and 1 specifying the probability level for the quantile. In the notation we defined above, the <code>output_type_id</code> corresponds to <span class="math inline">\(\theta\)</span> and the <code>value</code> of the prediction is the quantile estimate <span class="math inline">\(F^{-1}(\theta)\)</span>. For CDF or PMF predictions, the <code>output_type_id</code> is the value <span class="math inline">\(x\)</span> at which the cumulative distribution function or probability mass function for the predictive distribution should be evaluated, and the <code>value</code> column contains the estimate <span class="math inline">\(F(x)\)</span> or <span class="math inline">\(f(x)\)</span>, respectively. Requirements for the values of the <code>output_type_id</code> and <code>value</code> columns associated with each valid output type are summarized on the hubverse documentation website (<a href="https://hubdocs.readthedocs.io/en/latest/user-guide/model-output.#formats-of-model-output" class="uri">https://hubdocs.readthedocs.io/en/latest/user-guide/model-output.#formats-of-model-output</a>) and in <a href="#tbl-model-output-rep" class="quarto-xref">Table&nbsp;3</a>. <!--#ELR: I don't love the use of the word "estimate" that I introduced here -- noting that in much of statistics, a distinction is made between an estimate and a prediction, but I've used the two terms semi-interchangeably here. --> Finally, the <code>model_id</code> column gives a unique identifier of the model that created the predictions.</p>
<p>This representation of predictive model output is codified by the <code>model_out_tbl</code> S3 class in the <code>hubUtils</code> package, one of the foundational hubverse packages. Although this S3 class is required for all <code>hubEnsembles</code> functions, model predictions in other formats can easily be transformed using the <code>as_model_out_tbl()</code> function from <code>hubUtils</code>. An example of this transformation is provided in <a href="#sec-flu" class="quarto-xref">Section&nbsp;5</a>.</p>
<div id="tbl-model-output-rep" class="quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-model-output-rep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: A table summarizing how the model output representation columns are used for predictions of different output types. Adapted from <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>
</figcaption>
<div aria-describedby="tbl-model-output-rep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 33%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><code>output_type</code></th>
<th style="text-align: left;"><code>output_type_id</code></th>
<th style="text-align: left;"><code>value</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>mean</code></td>
<td style="text-align: left;">NA (not used for mean predictions)</td>
<td style="text-align: left;">Numeric: The mean of the predictive distribution</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>median</code></td>
<td style="text-align: left;">NA (not used for median predictions)</td>
<td style="text-align: left;">Numeric: The median of the predictive distribution</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>quantile</code></td>
<td style="text-align: left;">Numeric between 0.0 and 1.0: A probability level</td>
<td style="text-align: left;">Numeric: The quantile of the predictive distribution at the probability level specified by the <code>output_type_id</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cdf</code></td>
<td style="text-align: left;">Numeric within the support of the outcome variable: a possible value of the target variable</td>
<td style="text-align: left;">Numeric between 0.0 and 1.0: The value of the cumulative distribution function of the predictive distribution at the value of the outcome variable specified by the <code>output_type_id</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>pmf</code></td>
<td style="text-align: left;">String naming a possible category of a discrete outcome variable</td>
<td style="text-align: left;">Numeric between 0.0 and 1.0: The value of the probability mass function of the predictive distribution when evaluated at a specified level of a categorical outcome variable</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>sample</code></td>
<td style="text-align: left;">Positive integer sample index</td>
<td style="text-align: left;">Numeric: A sample from the predictive distribution</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="ensemble-functions-in-hubensembles" class="level2">
<h2 class="anchored" data-anchor-id="ensemble-functions-in-hubensembles">Ensemble functions in <code>hubEnsembles</code></h2>
<p>The <code>hubEnsembles</code> package includes two functions that perform ensemble calculations: <code>simple_ensemble()</code>, which applies some function to each model prediction, and <code>linear_pool()</code>, which computes an ensemble using the linear opinion pool method. In the following sections, we outline the implementation details for each function and how these implementations correspond to the statistical ensembling methods described in <a href="#sec-defs" class="quarto-xref">Section&nbsp;2</a>. A short description of the calculation performed by each function is summarized by output type in <a href="#tbl-fns-by-output-type" class="quarto-xref">Table&nbsp;4</a>.</p>
<section id="simple-ensemble" class="level3">
<h3 class="anchored" data-anchor-id="simple-ensemble">Simple ensemble</h3>
<p>The <code>simple_ensemble</code> function directly computes an ensemble from component model outputs by combining them via some function (<span class="math inline">\(C\)</span>) within each unique combination of task ID variables, output types, and output type IDs. This function can be used to summarize predictions of output types mean, median, quantile, CDF, and PMF. The mechanics of the ensemble calculations are the same for each of the output types, though the resulting statistical ensembling method differs for different output types (<a href="#tbl-fns-by-output-type" class="quarto-xref">Table&nbsp;4</a>). An aggregation function <span class="math inline">\(C\)</span> of choice may be specified by the user.</p>
<p>By default, <code>simple_ensemble</code> uses the mean for the aggregation function <span class="math inline">\(C\)</span> and equal weights for all models. For point predictions with a mean or median output type, the resulting ensemble prediction is an equally weighted average of the individual models’ predictions. For probabilistic predictions in a quantile format, by default <code>simple_ensemble</code> calculates an equally weighted average of individual model target variable values at each quantile level, which is equivalent to a quantile average. For model outputs in a CDF or PMF format, by default <code>simple_ensemble</code> computes an equally weighted average of individual model (cumulative or bin) probabilities at each target variable value, which is equivalent to the linear opinion pool method.</p>
<p>A median ensemble may also be created by specifying “median” as the aggregation function, or a custom function may be passed to the <code>agg_fun</code> argument to create other ensemble types. Similarly, model weights can be specified to create a weighted ensemble.</p>
<div id="tbl-fns-by-output-type" class="quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-fns-by-output-type-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Summary of ensemble function calculations for each output type. The ensemble function (columns) determines the operation that is performed, and in the case of probabilistic output types (quantile, cdf, pmf), this also determines what ensemble distribution is generated (quantile average, <span class="math inline">\(F_{Q}^{-1}(\theta)\)</span>, or linear pool, <span class="math inline">\(F_{LOP}(x)\)</span>). The resulting ensemble will be returned in the same output type as the inputs. Thus, the output type (rows) determines how the resulting ensemble distribution is summarized (as a quantile function, <span class="math inline">\(F^{-1}(\theta)\)</span>, cumulative distribution function, <span class="math inline">\(F(x)\)</span>, or probability mass function <span class="math inline">\(f(x)\)</span>). Estimating individual model cumulative probabilities is required to compute a <code>linear_pool()</code> for predictions of <code>quantile</code> output type; see <a href="#sec-linear-pool" class="quarto-xref">Section&nbsp;3.2.2</a> for details. In the case of <code>simple_ensemble()</code>, we report the calculations for the default case where <code>agg_fun = "mean"</code>; however, if another aggregation function is chosen (e.g., <code>agg_fun = "median"</code>), that calculation would be performed instead. For example, <code>simple_ensemble(..., agg_fun = "median")</code> applied to predictions of <code>mean</code> output type would return the median of individual model means.
</figcaption>
<div aria-describedby="tbl-fns-by-output-type-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 33%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>output_type</th>
<th><code>simple_ensemble(..., agg_fun = "mean")</code></th>
<th><code>linear_pool()</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>mean</code></td>
<td>mean of individual model means</td>
<td>mean of individual model means</td>
</tr>
<tr class="even">
<td><code>median</code></td>
<td>mean of individual model medians</td>
<td>NA</td>
</tr>
<tr class="odd">
<td><code>quantile</code></td>
<td>mean of individual model target variable values at each quantile level, <span class="math inline">\(F^{-1}_Q(\theta)\)</span></td>
<td>quantile of the distribution obtained by computing the mean of estimated individual model cumulative probabilities at each target variable value, <span class="math inline">\(F^{-1}_{LOP}(x)\)</span></td>
</tr>
<tr class="even">
<td><code>cdf</code></td>
<td>mean of individual model cumulative probabilities at each target variable value, <span class="math inline">\(F_{LOP}(x)\)</span></td>
<td>mean of individual model cumulative probabilities at each target variable value, <span class="math inline">\(F_{LOP}(x)\)</span></td>
</tr>
<tr class="odd">
<td><code>pmf</code></td>
<td>mean of individual model bin probabilities at each target variable value, <span class="math inline">\(f_{LOP}(x)\)</span></td>
<td>mean of individual model bin probabilities at each target variable value, <span class="math inline">\(f_{LOP}(x)\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="sec-linear-pool" class="level3">
<h3 class="anchored" data-anchor-id="sec-linear-pool">Linear pool</h3>
<p>The <code>linear_pool</code> function implements the linear opinion pool method for ensembling projections. This function can be used to combine predictions with output types mean, quantile, CDF, and PMF. Unlike <code>simple_ensemble</code>, this function handles its computation differently based on the output type. For the CDF, PMF, and mean output types, the linear pool method is equivalent to calling <code>simple_ensemble</code> with a mean aggregation function (see <a href="#tbl-fns-by-output-type" class="quarto-xref">Table&nbsp;4</a>), since <code>simple_ensemble</code> produces a linear pool prediction (an average of individual model cumulative or bin probabilities).</p>
<p>However, implementation of LOP is less straightforward for the quantile output type. This is because LOP averages CDF values (probabilities) at each value of the target variable, but the predictions are quantiles (on the scale of the target variable) for fixed probability levels. The value for these quantile predictions will generally differ between models, and as a result we are typically not provided CDF values at the same values of <span class="math inline">\(x\)</span> for all component predictions. This lack of alignment between CDF values for the same probability levels impedes computation of LOP from quantile forecasts and is illustrated in panel A of <a href="#fig-example-quantile-average-and-linear-pool" class="quarto-xref">Figure&nbsp;1</a></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-example-quantile-average-and-linear-pool" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-example-quantile-average-and-linear-pool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-example-quantile-average-and-linear-pool-1.png" class="img-fluid figure-img" width="6000">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-example-quantile-average-and-linear-pool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: (Panel A) Example of quantile output type predictions. In this example, points show model output collected for seven fixed quantile levels (<span class="math inline">\(\theta\)</span> = 0.01, 0.1, 0.3, 0.5, 0.7, 0.9, and 0.99) from two distributions (<span class="math inline">\(N(100, 10)\)</span> in purple and <span class="math inline">\(N(120, 5)\)</span> in green), with the underlying cumulative distribution functions (CDFs) shown with curves. The associated values for each fixed quantile level do not align across distributions (vertical lines). (Panel B) Quantile average ensemble, which is calculated by averaging values for each fixed quantile level (represented by horizontal dashed gray lines). The distributions and corresponding model outputs from panel A are re-plotted and the black line shows the resulting quantile average ensemble. Inset shows corresponding probability density functions (PDFs). (Panel C) Linear pool ensemble, which is calculated by averaging cumulative probabilities for each fixed value (represented by vertical dashed gray lines). The distributions and corresponding model outputs from panel A are re-plotted. To calculate the linear pool in this case, where model outputs are not defined for the same values, the model outputs are used to interpolate the full CDF for each distribution from which quantiles can be extracted for fixed values (shown with open circles). The black line shows the resulting linear pool average ensemble. Inset shows corresponding PDFs.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Given that LOP cannot be directly calculated from quantile predictions, we must first obtain an estimate of the CDF for each component distribution using the provided quantiles, combine the CDFs, then calculate the quantiles from the ensemble’s CDF. We perform this calculation in three main steps, assisted by the <code>distfromq</code> package <span class="citation" data-cites="distfromq">(<a href="#ref-distfromq" role="doc-biblioref">Ray and Gerding 2024</a>)</span> for the first two:</p>
<ol type="1">
<li>Interpolate and extrapolate from the provided quantiles for each component model to obtain an estimate of the CDF of that particular distribution.</li>
<li>Draw samples from each component model distribution. To reduce Monte Carlo variability, we use quasi-random samples corresponding to quantiles of the estimated distribution <span class="citation" data-cites="niederreiter1992quasirandom">(<a href="#ref-niederreiter1992quasirandom" role="doc-biblioref">Niederreiter 1992</a>)</span>.</li>
<li>Pool the samples from all component models and extract the desired quantiles.</li>
</ol>
<!--#EH COMMENT: DO WE WANT TO ADD A SENTENCE TO (2) THAT EXPLAINS HOW THE SAMPLING PROCESS APPROXIMATES THE AVERAGING THAT IS SHOWN IN FIG. 3.1C?.-->
<p>For step 1, functionality in the <code>distfromq</code> package uses a monotonic cubic spline for interpolation on the interior of the provided quantiles. The user may choose one of several distributions to perform extrapolation of the CDF tails. These include normal, lognormal, and cauchy distributions, with “normal” set as the default. A location-scale parameterization is used, with separate location and scale parameters chosen in the lower and upper tails so as to match the two most extreme quantiles.</p>
</section>
</section>
</section>
<section id="sec-simple-ex" class="level1">
<h1>Demonstration of functionality</h1>
<p>In this section, we provide a simple example to illustrate the two main functions in <code>hubEnsembles</code>, <code>simple_ensemble()</code> and <code>linear_pool()</code>.</p>
<section id="example-data-a-forecast-hub" class="level2">
<h2 class="anchored" data-anchor-id="example-data-a-forecast-hub">Example data: a forecast hub</h2>
<p>We will use an example hub provided by the hubverse to demonstrate the functionality of the <code>hubEnsembles</code> package (<a href="https://github.com/Infectious-Disease-Modeling-Hubs/example-complex-forecast-hub" class="uri">https://github.com/Infectious-Disease-Modeling-Hubs/example-complex-forecast-hub</a>). The example hub includes both example model output data and target data (sometimes known as “truth” data), which are included in the <code>hubEnsembles</code> package as data objects named <code>example_model_output</code> and <code>example_target_data</code>.</p>
<p>The model output data includes <code>quantile</code>, <code>mean</code> and <code>median</code> forecasts of future incident influenza hospitalizations and <code>pmf</code> forecasts of hospitalization intensity. Each forecast is made for five task ID variables, including the location for which the forecast was made (<code>location</code>), the date on which the forecast was made (<code>reference_date</code>), the number of steps ahead (<code>horizon</code>), the date of the forecast prediction (a combination of the date the forecast was made and the forecast horizon, <code>target_end_date</code>), and the forecast target (<code>target</code>). <a href="#tbl-example-forecasts" class="quarto-xref">Table&nbsp;5</a> provides an example of the quantile forecasts included in this data: 1-week ahead forecast of US incident hospitalizations made on December 17, 2022 from the Flusight-baseline model, the MOBS-GLEAM_FLUH model, and the PSI-DICE model. In <a href="#tbl-example-forecasts" class="quarto-xref">Table&nbsp;5</a>, we show only the median, the 50%, and 95% prediction intervals, although other intervals and <code>mean</code> forecasts are included in the example model output data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>hubEnsembles<span class="sc">::</span>example_model_output <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"quantile"</span>, <span class="st">"median"</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    output_type_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span>, <span class="cn">NA</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    horizon <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-example-forecasts" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Example model output for forecasts of incident influenza hospitalizations. A subset of example model output is shown: 1-week ahead quantile forecasts made on 2022-12-17 for the US from three distinct models; only the median, 50% prediction intervals, and 95% prediction intervals are displayed. This example data is provided in the <code>hubEnsembles</code> package and is a subset of the <code>example-complex-forecast-hub</code> data provided by the hubverse <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.
</figcaption>
<div aria-describedby="tbl-example-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["model_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["location"],"name":[2],"type":["chr"],"align":["left"]},{"label":["reference_date"],"name":[3],"type":["date"],"align":["right"]},{"label":["horizon"],"name":[4],"type":["int"],"align":["right"]},{"label":["target_end_date"],"name":[5],"type":["date"],"align":["right"]},{"label":["target"],"name":[6],"type":["chr"],"align":["left"]},{"label":["output_type"],"name":[7],"type":["chr"],"align":["left"]},{"label":["output_type_id"],"name":[8],"type":["chr"],"align":["left"]},{"label":["value"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.025","9":"18886"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.25","9":"23534"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.75","9":"24369"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.975","9":"28980"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"median","8":"NA","9":"23951"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.025","9":"14791"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.25","9":"20676"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.75","9":"30801"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.975","9":"42528"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"median","8":"NA","9":"25235"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.025","9":"14027"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.25","9":"16770"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.75","9":"23984"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.975","9":"27899"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"median","8":"NA","9":"19666"}],"options":{"columns":{"min":{},"max":[12]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>We also have corresponding target data included in the <code>hubEnsembles</code> package (<a href="#tbl-example-target-data" class="quarto-xref">Table&nbsp;6</a>). The example target data provide observed incident influenza hospitalizations (<code>value</code>) in a given week (<code>time_idx</code>) and for a given location (<code>location</code>). This target data could be used as calibration data for generating forecasts or for evaluating these forecasts post hoc. The forecast-specific task ID variables <code>reference_date</code> and <code>horizon</code> are not relevant for the target data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>hubEnsembles<span class="sc">::</span>example_target_data <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&gt;=</span> <span class="st">"2022-11-01"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&lt;=</span> <span class="st">"2023-02-01"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-example-target-data" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-target-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Example target data for incident influenza hospitalizations. This table includes target data from 2022-11-01 and 2023-02-01. This target data is provided in the <code>hubEnsembles</code> package and is a subset of the <code>example-complex-forecast-hub</code> target data provided by the hubverse <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.
</figcaption>
<div aria-describedby="tbl-example-target-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["time_idx"],"name":[1],"type":["date"],"align":["right"]},{"label":["location"],"name":[2],"type":["chr"],"align":["left"]},{"label":["value"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"2022-11-05","2":"US","3":"6571"},{"1":"2022-11-12","2":"US","3":"8848"},{"1":"2022-11-19","2":"US","3":"11427"},{"1":"2022-11-26","2":"US","3":"19846"},{"1":"2022-12-03","2":"US","3":"26333"},{"1":"2022-12-10","2":"US","3":"23851"},{"1":"2022-12-17","2":"US","3":"21435"},{"1":"2022-12-24","2":"US","3":"19286"},{"1":"2022-12-31","2":"US","3":"19369"},{"1":"2023-01-07","2":"US","3":"12928"},{"1":"2023-01-14","2":"US","3":"6692"},{"1":"2023-01-21","2":"US","3":"4182"},{"1":"2023-01-28","2":"US","3":"2838"}],"options":{"columns":{"min":{},"max":[13]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>We can plot these forecasts and the target data using the <code>plot_step_ahead_model_output()</code> function from <code>hubVis</code>, another package for visualizing model outputs from the hubverse suite (<a href="#fig-plot-ex-mods" class="quarto-xref">Figure&nbsp;2</a>). We subset the model output data and the target data to the location and time horizons we are interested in.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model_outputs_plot <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span>example_model_output <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  hubUtils<span class="sc">::</span><span class="fu">as_model_out_tbl</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"median"</span>, <span class="st">"mean"</span>, <span class="st">"quantile"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>target_data_plot <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span>example_target_data <span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&gt;=</span> <span class="st">"2022-11-01"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&lt;=</span> <span class="st">"2023-02-01"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>hubVis<span class="sc">::</span><span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_output_data =</span> model_outputs_plot,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth_data =</span> target_data_plot,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">facet =</span> <span class="st">"model_id"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">facet_nrow =</span> <span class="dv">1</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"US incident hospitalizations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plot-ex-mods" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot-ex-mods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-plot-ex-mods-1.png" class="img-fluid figure-img" width="4800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-ex-mods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: One example quantile forecast of weekly US incident influenza hospitalizations is shown for each of three models (panels). Forecasts are represented by a median (line), 50% prediction interval (Q25-Q75), and 95% prediction interval (Q2.5-Q97.5).
</figcaption>
</figure>
</div>
</div>
</div>
<p>Next, we examine the <code>pmf</code> target in the example model output data. For this target, teams forecasted the probability that hospitalization intensity will be “low”, “moderate”, “high”, or “very high”. The hospitalization intensity categories are determined by thresholds for weekly hospital admissions per 100,000 population. In other words, “low” hospitalization intensity in a given week means few incident influenza hospitalizations per 100,000 population, whereas “very high” hospitalization intensity means many hospitalizations per 100,000 population. These forecasts are made for the same task ID variables as the <code>quantile</code> forecasts of incident hospitalizations.</p>
<p>We show a representative example of the hospitalization intensity category forecasts in <a href="#tbl-example-forecasts-pmf" class="quarto-xref">Table&nbsp;7</a>. Because these forecasts are <code>pmf</code> output type, the <code>output_type_id</code> column specifies the bin of hospitalization intensity and the <code>value</code> column provides the forecasted probability of hospitalization incidence being in that category. Values sum to 1 across bins since they represent probabilities. For the MOBS-GLEAM_FLUH and PSI-DICE models, incidence is forecasted to decrease over the horizon (<a href="#fig-plot-ex-mods" class="quarto-xref">Figure&nbsp;2</a>), and correspondingly, the probability of “high” and “very high” hospitalization intensity is smaller for later horizons (<a href="#fig-plot-ex-mods-pmf" class="quarto-xref">Figure&nbsp;3</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hubEnsembles<span class="sc">::</span>example_model_output <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"pmf"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    horizon <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">round</span>(value, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-example-forecasts-pmf" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-forecasts-pmf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Example model output for forecasts of incident influenza hospitalization intensity. A subset of example model output is shown: 1-week ahead pmf forecasts made on 2022-12-17 for the US from three distinct models. We round the forecasted probability (in the <code>value</code> column) to two digits. This example data is provided in the <code>hubEnsembles</code> package and is a subset of the <code>example-complex-forecast-hub</code> data provided by the hubverse <span class="citation" data-cites="hubverse_docs">(<a href="#ref-hubverse_docs" role="doc-biblioref">hubverse 2022</a>)</span>.
</figcaption>
<div aria-describedby="tbl-example-forecasts-pmf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["model_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["location"],"name":[2],"type":["chr"],"align":["left"]},{"label":["reference_date"],"name":[3],"type":["date"],"align":["right"]},{"label":["horizon"],"name":[4],"type":["int"],"align":["right"]},{"label":["target_end_date"],"name":[5],"type":["date"],"align":["right"]},{"label":["target"],"name":[6],"type":["chr"],"align":["left"]},{"label":["output_type"],"name":[7],"type":["chr"],"align":["left"]},{"label":["output_type_id"],"name":[8],"type":["chr"],"align":["left"]},{"label":["value"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"low","9":"0.00"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"moderate","9":"0.01"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"high","9":"0.86"},{"1":"Flusight-baseline","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"very high","9":"0.13"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"low","9":"0.00"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"moderate","9":"0.07"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"high","9":"0.41"},{"1":"MOBS-GLEAM_FLUH","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"very high","9":"0.52"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"low","9":"0.00"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"moderate","9":"0.23"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"high","9":"0.60"},{"1":"PSI-DICE","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"very high","9":"0.17"}],"options":{"columns":{"min":{},"max":[9]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-ex-mods-pmf" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot-ex-mods-pmf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-plot-ex-mods-pmf-1.png" class="img-fluid figure-img" width="4800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-ex-mods-pmf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: One example pmf forecast of incident influenza hospitalization intensity is shown for each of three models (panels). Each bar shows forecasts of horizon 0-3 weeks, and the darkness of the bar shows the hospitalization intensity bins (low, moderate, high, and very high).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="creating-ensembles-with-simple_ensemble" class="level2">
<h2 class="anchored" data-anchor-id="creating-ensembles-with-simple_ensemble">Creating ensembles with <code>simple_ensemble</code></h2>
<p>Using the default options for <code>simple_ensemble()</code>, we can generate an equally weighted mean ensemble for each unique combination of values for the task ID variables (here, <code>reference_date</code>, <code>horizon</code>, <code>target_end_date</code>, <code>location</code>, and <code>target</code>), the <code>output_type</code> and the <code>output_type_id</code>. Note that this means that different ensemble methods are used for different output types: for the <code>quantile</code> output type in our example data, the resulting ensemble is a quantile average, while for the <code>pmf</code> output type, the ensemble is a linear pool.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mean_ens <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(hubEnsembles<span class="sc">::</span>example_model_output,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="st">"simple-ensemble-mean"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting model output has the same structure as the original model output data (<a href="#tbl-mean-ensemble" class="quarto-xref">Table&nbsp;8</a>), with columns for model ID, task ID variables, output type, output type ID, and value. We also use <code>model_id = "simple-ensemble-mean</code> to change the name of this ensemble in the resulting model output; if not specified, the default will be “hub-ensemble”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mean_ens <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"quantile"</span>, <span class="st">"median"</span>, <span class="st">"pmf"</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    output_type_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span>, <span class="cn">NA</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"low"</span>, <span class="st">"moderate"</span>, <span class="st">"high"</span>, <span class="st">"very high"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    horizon <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-mean-ensemble" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-mean-ensemble-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: Mean ensemble model output. The values in the model_id column are determined by <code>simple_ensemble(..., model_id = )</code> argument). A subset of ensemble model output is shown: 1-week ahead pmf forecasts made on 2022-12-17 for the US. Results are generated for all output types. Here, we show only the median, 50% prediction intervals, and 95% prediction intervals for the quantile output type and all bins for the pmf output type.
</figcaption>
<div aria-describedby="tbl-mean-ensemble-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["model_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["location"],"name":[2],"type":["chr"],"align":["left"]},{"label":["reference_date"],"name":[3],"type":["date"],"align":["right"]},{"label":["horizon"],"name":[4],"type":["int"],"align":["right"]},{"label":["target_end_date"],"name":[5],"type":["date"],"align":["right"]},{"label":["target"],"name":[6],"type":["chr"],"align":["left"]},{"label":["output_type"],"name":[7],"type":["chr"],"align":["left"]},{"label":["output_type_id"],"name":[8],"type":["chr"],"align":["left"]},{"label":["value"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"high","9":"6.234734e-01"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"low","9":"5.126764e-05"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"moderate","9":"1.029102e-01"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk flu hosp rate category","7":"pmf","8":"very high","9":"2.735651e-01"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"median","8":"NA","9":"2.295067e+04"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.025","9":"1.590133e+04"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.25","9":"2.032667e+04"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.75","9":"2.638467e+04"},{"1":"simple-ensemble-mean","2":"US","3":"2022-12-17","4":"1","5":"2022-12-24","6":"wk inc flu hosp","7":"quantile","8":"0.975","9":"3.313567e+04"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[9],"max":[9]},"pages":{}}}
  </script>
</div>
</div>
</div>
</figure>
</div>
</div>
<section id="changing-the-aggregation-function" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-aggregation-function">Changing the aggregation function</h3>
<p>We can change the function that is used to aggregate model outputs. For example, we may want to calculate a median of the component models’ submitted values for each quantile. We do so by specifying <code>agg_fun = median</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>median_ens <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(hubEnsembles<span class="sc">::</span>example_model_output,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">agg_fun =</span> median,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="st">"simple-ensemble-median"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Custom functions can also be passed into the <code>agg_fun</code> argument. We illustrate this by defining a custom function, <code>geometric_mean</code>, to compute the ensemble prediction as a geometric mean of the component model predictions. Any custom function to be used must have an argument <code>x</code> for the vector of numeric values to summarize, and if relevant, an argument <code>w</code> of numeric weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>geometric_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">prod</span>(x)<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> n))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>geometric_mean_ens <span class="ot">&lt;-</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(hubEnsembles<span class="sc">::</span>example_model_output,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">agg_fun =</span> geometric_mean,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_id =</span> <span class="st">"simple-ensemble-geometric"</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, the mean, median, and geometric mean each give us slightly different resulting ensembles. The median point estimates, 50% prediction intervals, and 95% prediction intervals in <a href="#fig-plot-ensembles" class="quarto-xref">Figure&nbsp;4</a> demonstrate this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model_output_plot <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  mean_ens, median_ens,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  geometric_mean_ens</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"median"</span>, <span class="st">"mean"</span>, <span class="st">"quantile"</span>),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_date =</span> reference_date <span class="sc">+</span> horizon)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>target_data_plot <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span>example_target_data <span class="sc">|&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>, time_idx <span class="sc">&gt;=</span> <span class="st">"2022-11-01"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&lt;=</span> <span class="st">"2023-03-01"</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>hubVis<span class="sc">::</span><span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_output_data =</span> model_output_plot,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth_data =</span> target_data_plot,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"US incident hospitalizations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plot-ensembles" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot-ensembles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-plot-ensembles-1.png" class="img-fluid figure-img" width="4800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-ensembles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Three different ensembles for weekly US incident influenza hospitalizations. Each ensemble combines individual predictions from the example hub (<a href="#fig-plot-ex-mods" class="quarto-xref">Figure&nbsp;2</a>) using a different method: arithmetic mean, geometric mean, or median. All methods correspond to variations of the quantile average approach.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="weighting-model-contributions" class="level3">
<h3 class="anchored" data-anchor-id="weighting-model-contributions">Weighting model contributions</h3>
<p>We can weight the contributions of each model in the ensemble using the <code>weights</code> argument of <code>simple_ensemble</code>. This arguement takes a <code>data.frame</code> that should include a <code>model_id</code> column containing each unique model_id and a <code>weight</code> column. In the following example, we include the baseline model in the ensemble, but give it less weight than the other forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model_weights <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="fu">c</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MOBS-GLEAM_FLUH"</span>, <span class="st">"PSI-DICE"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"simple_hub-baseline"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>weighted_mean_ens <span class="ot">&lt;-</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    hubEnsembles<span class="sc">::</span>example_model_output,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> model_weights,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_id =</span> <span class="st">"simple-ensemble-weighted-mean"</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="creating-ensembles-with-linear_pool" class="level2">
<h2 class="anchored" data-anchor-id="creating-ensembles-with-linear_pool">Creating ensembles with <code>linear_pool</code></h2>
<p>We can also generate a linear pool ensemble, or distributional mixture, using the <code>linear_pool()</code> function; this function can be applied to predictions with an <code>output_type</code> of <code>mean</code>, <code>quantile</code>, <code>cdf</code>, or <code>pmf</code>. Our example hub includes <code>median</code> output type, so we exclude it from the calculation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>linear_pool_ens <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  hubEnsembles<span class="sc">::</span><span class="fu">linear_pool</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      hubEnsembles<span class="sc">::</span>example_model_output,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      output_type <span class="sc">!=</span> <span class="st">"median"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_id =</span> <span class="st">"linear-pool"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As described above, for <code>quantile</code> model outputs, the <code>linear_pool</code> function approximates the full probability distribution for each component prediction using the value-quantile pairs provided by that model, and then obtains quasi-random samples from that distributional estimate. The number of samples drawn from the distribution of each component model defaults to <code>1e4</code>, but this can be changed using the <code>n_samples</code> argument.</p>
<p>In <a href="#fig-plot-ex-quantile-and-linear-pool" class="quarto-xref">Figure&nbsp;5</a>, we compare ensemble results generated by <code>simple_ensemble</code> and <code>linear_pool</code> for model outputs of output types PMF and quantile. As expected, the results from the two functions are equivalent for the PMF output type: for this output type, the <code>simple_ensemble</code> method averages the predicted probability of each category across the component models, which is the definition of the linear pool ensemble method. This is not the case for the quantile output type, because the <code>simple_ensemble</code> is computing a quantile average.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  mean_ens,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  linear_pool_ens</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">==</span> <span class="st">"pmf"</span>, reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">output_type_id =</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, output_type_id)) <span class="sc">|&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">output_type_id =</span> <span class="fu">factor</span>(output_type_id,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"low"</span>, <span class="st">"moderate"</span>, <span class="st">"high"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"very high"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> output_type_id, <span class="at">y =</span> value, <span class="at">fill =</span> model_id)) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(horizon), <span class="at">labeller =</span> label_both) <span class="sc">+</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"US incident hospitalization intensity"</span>, <span class="at">y =</span> <span class="st">"probability"</span>) <span class="sc">+</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_blank</span>(), <span class="at">strip.placement =</span> <span class="st">"outside"</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>model_output_plot <span class="ot">&lt;-</span> linear_pool_ens <span class="sc">|&gt;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(output_type_id <span class="sc">==</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">output_type =</span> <span class="st">"median"</span>, <span class="at">output_type_id =</span> <span class="cn">NA</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>model_output_plot <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(linear_pool_ens, model_output_plot)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>model_output_plot <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(mean_ens, model_output_plot) <span class="sc">|&gt;</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"median"</span>, <span class="st">"mean"</span>, <span class="st">"quantile"</span>),</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_date =</span> reference_date <span class="sc">+</span> horizon)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>target_data_plot <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span>example_target_data <span class="sc">|&gt;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"US"</span>, time_idx <span class="sc">&gt;=</span> <span class="st">"2022-11-01"</span>,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    time_idx <span class="sc">&lt;=</span> <span class="st">"2023-03-01"</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  hubVis<span class="sc">::</span><span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_output_data =</span> model_output_plot,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth_data =</span> target_data_plot,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">pal_color =</span> <span class="st">"Set1"</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_legend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"US incident hospitalizations"</span>)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">get_legend</span>(p1)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    p1 <span class="sc">+</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>          <span class="st">"example PMF output type"</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>),</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    p2 <span class="sc">+</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>          <span class="st">"example quantile output type"</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>),</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>  ), l,</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">0.95</span>, <span class="fl">0.05</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plot-ex-quantile-and-linear-pool" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot-ex-quantile-and-linear-pool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-plot-ex-quantile-and-linear-pool-1.png" class="img-fluid figure-img" width="6000">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-ex-quantile-and-linear-pool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Comparison of results from <code>simple_ensemble</code> (blue) and <code>linear pool</code> (red). (Panel A) Ensemble predictions of US incident influenza hospitalization intensity (classified as low, moderate, high, or very high), which provide an example of PMF output type. (Panel B) Ensemble predictions of weekly US incident influenza hospitalizations, which provide an example of quantile output type. Note, for quantile output type, <code>simple_ensemble</code> corresponds to a quantile average. Ensembles combine individual models from the example hub (<a href="#fig-plot-ex-mods" class="quarto-xref">Figure&nbsp;2</a>).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-flu" class="level1">
<h1>Case study: Weekly incident flu hospitalizations</h1>
<p>To demonstrate the utility of the <code>hubEnsembles</code> package and the differences between the two ensembling functions, we examine the case of predicting weekly influenza hospitalizations in the US.</p>
<p>Since 2013, the US Centers for Disease Control and Prevention (CDC) has been soliciting forecasts of seasonal influenza from modeling teams through a collaborative challenge called FluSight <span class="citation" data-cites="cdc_flusight">(<a href="#ref-cdc_flusight" role="doc-biblioref">CDC 2023</a>)</span>. We use a subset of these predictions to create four equally-weighted ensembles with <code>simple_ensemble()</code> and <code>linear_pool()</code> and compare the resulting models’ performance. The ensembling methods chosen for this case study consist of a quantile (arithmetic) mean, a quantile median, a linear pool with normal tails, and a linear pool with lognormal tails. Note that only a select portion of the code is shown in this manuscript for brevity, though all the functions and scripts used to generate the case study results can be found in the associated GitHub repository hubEnsemblesManuscript (<a href="https://github.com/Infectious-Disease-Modeling-Hubs/hubEnsemblesManuscript" class="uri">https://github.com/Infectious-Disease-Modeling-Hubs/hubEnsemblesManuscript</a>).</p>
<p>We began by querying the component forecasts used to generate the four ensembles from zoltar, a repository designed to archive forecasts created by the Reich Lab at UMass Amherst. We were only interested in predictions in a quantile format from FluSight, so we only load in influenza forecasts from the 2021-2022 and 2022-2023 seasons. These forecasts were stored in two data objects, split by season, called <code>flu_forecasts-raw_21-22.rds</code> and <code>flu_forecasts-raw_22-23.rds</code>. Since zoltar has its own formatting conventions, the raw forecasts must be transformed to fit hubverse standards before being fed into either of the ensembling functions. To do so, we use the <code>as_model_out_tbl()</code> function from the <code>hubUtils</code> package. Here, we specified the task ID variables as forecast date (when the forecast was made), location, horizon, and target.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>flu_forecasts_raw_21_22 <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"analysis/data/raw_data/flu_forecasts-raw_21-22.rds"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>flu_forecasts_raw_22_23 <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"analysis/data/raw_data/flu_forecasts-raw_22-23.rds"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>flu_forecasts_raw <span class="ot">&lt;-</span> <span class="fu">rbind</span>(flu_forecasts_raw_21_22, flu_forecasts_raw_22_23)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>flu_forecasts_raw_21_22 <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"analysis/data/raw_data/flu_forecasts-raw_21-22.rds"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>flu_forecasts_hubverse <span class="ot">&lt;-</span> flu_forecasts_raw <span class="sc">|&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">forecast_date =</span> timezero, <span class="at">location =</span> unit) <span class="sc">|&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">separate</span>(target,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">" "</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"horizon"</span>, <span class="st">"target"</span>), <span class="at">extra =</span> <span class="st">"merge"</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_model_out_tbl</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_id_col =</span> <span class="st">"model"</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type_col =</span> <span class="st">"class"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type_id_col =</span> <span class="st">"quantile"</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_col =</span> <span class="st">"value"</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"-"</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">trim_to_task_ids =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">hub_con =</span> <span class="cn">NULL</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">task_id_cols =</span> <span class="fu">c</span>(</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">"forecast_date"</span>, <span class="st">"location"</span>, <span class="st">"horizon"</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">"target"</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_empty =</span> <span class="cn">TRUE</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our only inclusion criteria for the component forecasts to be used in the ensembles were that every prediction (defined by a unique combination of task ID variables) was made for all 23 quantiles specified by FluSight (Q = {.010, 0.025, .050, .100, …, .900, .950, .990}) and that they were not generated by the Flusight baseline or median ensemble models. In practice, this means that all forecasts made by outside teams were included in the four ensembles for this paper, matching the real-time fluctuation in how many models were used to generate the median ensemble run by FluSight (since number of submitted models could vary from week to week).</p>
<p>With these inclusion criteria, the final data set of component forecasts consisted of predictions from 25 modeling teams for 42 models, 53 forecast dates (one per week), 54 US locations, 4 horizons, 1 target, and 23 quantiles. In the 2021-2022 season 23 models made predictions for 22 weeks spanning from late January 2022 to late June 2022 while the 2022-2023 season saw 18 models making predictions for 31 weeks spanning mid-October 2022 to mid-May 2023. Both seasons forecasted for the same locations (the 50 states, Washington DC, Puerto Rico, the Virgin Islands, and the US as a whole), horizons (1 to 4 weeks ahead), quantiles (the 23 described above), and target (week ahead incident flu hospitalization). The values for the forecasts are always non-negative. Below in <a href="#tbl-case-study-flu-forecasts" class="quarto-xref">Table&nbsp;9</a> we print several rows of these predictions for select quantiles of a single model, forecast date, horizon, and location.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">read_rds</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"analysis/data/raw_data/flu_forecasts-small.rds"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    model_id <span class="sc">==</span> <span class="st">"UMass-trends_ensemble"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    forecast_date <span class="sc">==</span> <span class="st">"2023-05-15"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">==</span> <span class="st">"06"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    horizon <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    output_type_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>, <span class="fl">0.975</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-case-study-flu-forecasts" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-case-study-flu-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9: Select quantiles of weekly incident influenza hospitalizations made for FluSight formatted according to hubverse standards made on May 15, 2023 for California at the 1 week ahead horizon.
</figcaption>
<div aria-describedby="tbl-case-study-flu-forecasts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 18%">
<col style="width: 11%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 18%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model_id</th>
<th style="text-align: left;">forecast_date</th>
<th style="text-align: left;">season</th>
<th style="text-align: left;">location</th>
<th style="text-align: right;">horizon</th>
<th style="text-align: left;">target</th>
<th style="text-align: left;">output_type</th>
<th style="text-align: right;">output_type_id</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.100</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.250</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.750</td>
<td style="text-align: right;">46</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.900</td>
<td style="text-align: right;">56</td>
</tr>
<tr class="even">
<td style="text-align: left;">UMass-trends_ensemble</td>
<td style="text-align: left;">2023-05-15</td>
<td style="text-align: left;">2022-2023</td>
<td style="text-align: left;">06</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">wk ahead inc flu hosp</td>
<td style="text-align: left;">quantile</td>
<td style="text-align: right;">0.975</td>
<td style="text-align: right;">68</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Next, the component model outputs are combined using the following code to generate predictions from each ensemble model. The resulting ensemble forecasts will have the same task ID variables, model output specifications, and general data set features (albeit for 4 total models instead of 42).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>flu_forecasts_hubverse <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  flu_forecasts_hubverse,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  model_id <span class="sc">!=</span> <span class="st">"Flusight-baseline"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>mean_ensemble <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(flu_forecasts_hubverse,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">agg_fun =</span> <span class="st">"mean"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="st">"mean-ensemble"</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>median_ensemble <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">simple_ensemble</span>(flu_forecasts_hubverse,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">agg_fun =</span> <span class="st">"median"</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="st">"median-ensemble"</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>lp_normal <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">linear_pool</span>(flu_forecasts_hubverse,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_samples =</span> <span class="fl">1e5</span>, <span class="at">model_id =</span> <span class="st">"lp-normal"</span>,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">tail_dist =</span> <span class="st">"norm"</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>lp_lognormal <span class="ot">&lt;-</span> hubEnsembles<span class="sc">::</span><span class="fu">linear_pool</span>(flu_forecasts_hubverse,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_samples =</span> <span class="fl">1e5</span>,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_id =</span> <span class="st">"lp-lognormal"</span>,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">tail_dist =</span> <span class="st">"lnorm"</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We run the above code only one time and save the results in data objects split by a model and season, which then can be loaded in to plot and score. Scoring of the forecasts (not shown) is likewise performed only once, with the results saved in data objects. The component predictions are scored for every unique combination of task ID variables against target data with the <code>score_forecasts()</code> function from the <code>covidHubUtils</code> package. This function outputs scores that we can use to calculate several common metrics in forecast evaluation, including weighted interval score (WIS) <span class="citation" data-cites="bracher_evaluating_2021">(<a href="#ref-bracher_evaluating_2021" role="doc-biblioref">Bracher et al. 2021</a>)</span>, mean absolute error (MAE), 50% prediction interval (PI) coverage, and 95% PI coverage. Of these metrics, WIS and PI coverage evaluate probabilistic forecasts while MAE evaluates point forecasts (which in hubverse terms corresponds to an output type of either mean or median). In this analysis, we use median forecasts taken from the 0.5 quantile.</p>
<p>WIS measures how consistent a set of prediction intervals is with the observed value and is an alternative to common proper scoring rules like the Log Score and Continuous Ranked Probability Score, which can’t be evaluated directly for quantile forecasts <span class="citation" data-cites="bracher_evaluating_2021">(<a href="#ref-bracher_evaluating_2021" role="doc-biblioref">Bracher et al. 2021</a>)</span>. Since WIS is made up of three component penalties—one for each of spread, over-prediction, and under-prediction—a lower value indicates a more accurate forecast <span class="citation" data-cites="bracher_evaluating_2021">(<a href="#ref-bracher_evaluating_2021" role="doc-biblioref">Bracher et al. 2021</a>)</span>. The <span class="math inline">\((1-\alpha)*100\)</span>% PI coverage measures the proportion of the time that PIs at that nominal level included the true value, which provides information about whether a forecast has accurately characterized its uncertainty about future observations. Achieving approximately nominal (<span class="math inline">\((1-\alpha)*100\)</span>%) coverage indicates a well-calibrated forecast. MAE measures the average absolute error of a set of forecasts against the true value; smaller values of MAE indicate better forecast accuracy.</p>
<p>We also use relative versions of WIS and MAE (rWIS and rMAE, respectively) to evaluate ensemble performance relative to the FluSight baseline model. These metrics are calculated as follows <span class="math display">\[\textrm{rWIS} = \frac{\textrm{WIS}_{\textrm{model }m}}{\textrm{WIS}_{\textrm{baseline}}} \hspace{3cm} \textrm{rMAE} = \frac{\textrm{MAE}_{\textrm{model }m}}{\textrm{MAE}_{\textrm{baseline}}},\]</span> where model <span class="math inline">\(m\)</span> is any given model being compared against the baseline. For both of these metrics, a value less than one indicates better performance compared to the baseline while a value greater than one indicates worse performance. By definition, the FluSight baseline itself will always have a value of one for both of these metrics.</p>
<p>We calculate these metrics for the four ensembles (as well as the Flusight baseline) over all the forecasts using the <code>evaluate_flu_scores()</code> function stored in the <code>evaluation_functions.R</code> script. The results show that the quantile median ensemble had the best overall performance in terms of WIS and MAE (and the relative versions of these metrics) with above-nominal coverage rates (<a href="#tbl-overall-evaluation" class="quarto-xref">Table&nbsp;10</a>). The two linear opinion pools had very similar performance to each other. These methods had the second-best performance as measured by WIS and MAE, but they had the highest 50% and 95% coverage rates, with empirical coverage that was well above the nominal coverage rate. The quantile mean performed the worst of the ensembles with the highest MAE, which was substantially different from that of the other ensembles.</p>
<div class="cell">
<div id="tbl-overall-evaluation" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-overall-evaluation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;10: Summary of overall model performance across both seasons, averaged over all locations except the US national location. The best values for each metric is bolded, though the metric values are often quite similar among the models.
</figcaption>
<div aria-describedby="tbl-overall-evaluation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 24%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: left;">wis</th>
<th style="text-align: left;">rwis</th>
<th style="text-align: left;">mae</th>
<th style="text-align: left;">rmae</th>
<th style="text-align: left;">cov50</th>
<th style="text-align: left;">cov95</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>median-ensemble</strong></td>
<td style="text-align: left;"><strong>18.158</strong></td>
<td style="text-align: left;"><strong>0.794</strong></td>
<td style="text-align: left;"><strong>27.36</strong></td>
<td style="text-align: left;"><strong>0.933</strong></td>
<td style="text-align: left;"><em>0.597</em></td>
<td style="text-align: left;"><strong>0.922</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">lp-normal</td>
<td style="text-align: left;">19.745</td>
<td style="text-align: left;">0.863</td>
<td style="text-align: left;">27.932</td>
<td style="text-align: left;">0.953</td>
<td style="text-align: left;">0.709</td>
<td style="text-align: left;">0.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lp-lognormal</td>
<td style="text-align: left;">19.747</td>
<td style="text-align: left;">0.863</td>
<td style="text-align: left;">27.933</td>
<td style="text-align: left;">0.953</td>
<td style="text-align: left;">0.708</td>
<td style="text-align: left;">0.99</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean-ensemble</td>
<td style="text-align: left;">20.18</td>
<td style="text-align: left;">0.882</td>
<td style="text-align: left;">29.582</td>
<td style="text-align: left;">1.009</td>
<td style="text-align: left;"><strong>0.595</strong></td>
<td style="text-align: left;">0.889</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Flusight-baseline</td>
<td style="text-align: left;">22.876</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">29.315</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.604</td>
<td style="text-align: left;">0.881</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Plots of the models’ forecasts can aid our understanding about the origin of these accuracy differences. For example, the linear opinion pools, which had the highest coverage rates, consistently had some of the widest prediction intervals. The median ensemble, which had the best WIS, seems to have best-balanced interval width overall, with narrower intervals than the linear pools that achieved near-nominal coverage on average across all time points. The quantile mean’s interval widths could vary, though it usually had narrower intervals than the linear pools. However, this model’s point forecasts demonstrated a larger error margin compared to the other ensembles, especially at longer horizons. This can be seen in <a href="#fig-plot-forecasts-hubVis" class="quarto-xref">Figure&nbsp;6</a> for the 4-week ahead forecast in California following the 2022-23 season peak on December 5, 2022. Here the quantile mean predicted a continued increase in hospitalizations, at a steeper slope than the other ensemble methods.</p>
<!-- ELR: comments on the plot below:
 - can we get it so that there is not a line during the off season in this plot?
-->
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Flusight-baseline"</span>, <span class="st">"lp-lognormal"</span>, <span class="st">"lp-normal"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean-ensemble"</span>, <span class="st">"median-ensemble"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>flu_dates_21_22 <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-24"</span>) <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">21</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>flu_dates_22_23 <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2022-10-17"</span>) <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>flu_dates_off_season <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2022-06-27"</span>) <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">15</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>all_flu_dates <span class="ot">&lt;-</span> <span class="fu">c</span>(flu_dates_21_22, flu_dates_22_23)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>select_dates <span class="ot">&lt;-</span> <span class="fu">c</span>(all_flu_dates[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">69</span>, <span class="dv">4</span>)], flu_dates_21_22[<span class="dv">22</span>] <span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  lubridate<span class="sc">::</span><span class="fu">weeks</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>forecasts_ca <span class="ot">&lt;-</span> flu_forecasts_ensembles <span class="sc">|&gt;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(<span class="fu">expand.grid</span>(</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_id =</span> model_names[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_date =</span> flu_dates_21_22[<span class="dv">22</span>] <span class="sc">+</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>      lubridate<span class="sc">::</span><span class="fu">weeks</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>),</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="fu">unique</span>(flu_truth_all<span class="sc">$</span>location),</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizon =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"wk ahead inc flu hosp"</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type =</span> <span class="st">"quantile"</span>,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type_id =</span> <span class="fu">c</span>(</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      <span class="fl">0.01</span>, <span class="fl">0.025</span>, <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="fl">0.5</span>),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="fl">0.975</span>, <span class="fl">0.99</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="cn">NA</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_end_date =</span> forecast_date <span class="sc">+</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      lubridate<span class="sc">::</span><span class="fu">weeks</span>(horizon), <span class="at">.before =</span> target)) <span class="sc">|&gt;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(location <span class="sc">==</span> <span class="st">"06"</span>, forecast_date <span class="sc">%in%</span> select_dates) <span class="sc">|&gt;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(forecast_date) <span class="sc">|&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_model_out_tbl</span>()</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>truth_ca <span class="ot">&lt;-</span> flu_truth_all <span class="sc">|&gt;</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(location <span class="sc">==</span> <span class="st">"06"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(<span class="fu">expand.grid</span>(</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"flu-truth"</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_variable =</span> <span class="st">"inc flu hosp"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_end_date =</span> flu_dates_21_22[<span class="dv">22</span>] <span class="sc">+</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>      lubridate<span class="sc">::</span><span class="fu">weeks</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>),</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="fu">unique</span>(flu_truth_all<span class="sc">$</span>location),</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="cn">NA</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>ca_plot_ensembles <span class="ot">&lt;-</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    forecasts_ca <span class="sc">|&gt;</span> <span class="fu">filter</span>(model_id <span class="sc">!=</span> <span class="st">"Flusight-baseline"</span>), </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    truth_ca,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_truth_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet =</span> <span class="st">"model_id"</span>,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet_scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet_nrow =</span> <span class="dv">3</span>,</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">pal_color =</span> <span class="st">"Set2"</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_transparency =</span> <span class="fl">0.45</span>,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>ca_plot_ensembles <span class="ot">&lt;-</span> ca_plot_ensembles <span class="sc">+</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>),</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2023-06-08"</span>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">"4 months"</span>, <span class="at">date_labels =</span> <span class="st">"%b '%y"</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> model_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Set2"</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> model_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Set2"</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.length.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"cm"</span>),</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="dv">7</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>),</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>ca_plot_baseline <span class="ot">&lt;-</span></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    forecasts_ca <span class="sc">|&gt;</span> <span class="fu">filter</span>(model_id <span class="sc">==</span> <span class="st">"Flusight-baseline"</span>), </span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>    truth_ca,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_plot =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_truth_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet =</span> <span class="st">"model_id"</span>,</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet_scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet_nrow =</span> <span class="dv">1</span>,</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_transparency =</span> <span class="fl">0.45</span>,</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>),</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2023-06-08"</span>)</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">"4 months"</span>, <span class="at">date_labels =</span> <span class="st">"%b '%y"</span></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.length.x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>),</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="co">#element_text(vjust = 5, hjust = -0.2),</span></span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>ca_plot_all <span class="ot">&lt;-</span></span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    forecasts_ca <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">facet_name =</span> <span class="st">"All models, same scale"</span>),</span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    truth_ca,</span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_plot =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_truth_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet =</span> <span class="st">"facet_name"</span>,</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">interactive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_transparency =</span> <span class="fl">0.45</span>,</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>),</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>),</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"2023-06-08"</span>)</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_breaks =</span> <span class="st">"4 months"</span>, <span class="at">date_labels =</span> <span class="st">"%b '%y"</span></span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.length.x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>),</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>((ca_plot_all <span class="sc">|</span> ca_plot_baseline) <span class="sc">/</span> ca_plot_ensembles) <span class="sc">+</span></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">guides=</span><span class="st">'collect'</span>, <span class="at">heights=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a><span class="co">#  plot_layout(guides='collect', axes='collect', axis_titles = 'collect', heights=c(1, 2)) +</span></span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Weekly Incident "</span>,</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hospitalizations for Influenza "</span>,</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">"in California"</span></span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plot-forecasts-hubVis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot-forecasts-hubVis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-plot-forecasts-hubVis-1.png" class="img-fluid figure-img" width="7200">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-forecasts-hubVis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: TO BE FIXED: One to four week ahead forecasts for select dates plotted against target data for California, faceted by model. The first facet shows all models being plotted on the same scale for a magnitude comparison, while the other facets of individual model forecasts have y scales that are allowed to vary to better show prediction accuracy as compared to observed influenza hospitalizations.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can use additional functions from the <code>evaluation_functions.R</code> script to examine model performance with greater granularity. For example, we may use the following lines of code to generate a table similar to <a href="#tbl-overall-evaluation" class="quarto-xref">Table&nbsp;10</a> but that shows scores from week to week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>flu_date_horizon_season_states <span class="ot">&lt;-</span> flu_scores_all <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">evaluate_flu_scores</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grouping_variables =</span> <span class="fu">c</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"horizon"</span>, <span class="st">"forecast_date"</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"season"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_name =</span> <span class="st">"Flusight-baseline"</span>, <span class="at">us_only =</span> <span class="cn">FALSE</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, reading and interpreting such a table becomes unwieldy with 53 weeks of forecasts. Instead, the above summarized scores can be separated by metric, filtered by horizon, and plotted against truth data using the <code>plot_evaluated_scores_forecast_date()</code> shown in the code chunk below. (In practice, we also split the predictions by season for improve readability, but this step is not strictly necessary.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>flu_date_horizon_season_states <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(season <span class="sc">==</span> <span class="st">"2021-2022"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_evaluated_scores_forecast_date</span>(model_names, model_colors,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">h =</span> <span class="dv">1</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_var =</span> <span class="st">"mae"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"MAE 2021-2022, 1 week ahead"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth_data =</span> flu_truth_all,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth_scaling =</span> <span class="fl">0.1</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then may combine several of these plots to obtain a complete picture by plotting every metric and the 1 and 4 week ahead horizons. From these combined plots we can see that the ensemble models tend to have similar MAE values during the entire time period, with slight divergence in MAE values for certain weeks at the four week ahead horizon (<a href="#fig-mae-vs-forecast-date" class="quarto-xref">Figure&nbsp;7</a>). However, the models show greater differences for the other two metrics, particularly during times of rapid change (<a href="#fig-wis-vs-forecast-date" class="quarto-xref">Figure&nbsp;8</a> and <a href="#fig-cov95-vs-forecast-date" class="quarto-xref">Figure&nbsp;9</a>), with the scores aligning near-perfectly with the observed weekly incident hospitalizations. In fact, the linear pools have a lower WIS than the median ensemble at the one week ahead forecast horizon for over a third of forecast dates (11 weeks) during the 2022-2023 season: from October 17, 2022 to December 12, 2022; January 2, 2023; and January 9, 2023 (<a href="#fig-wis-vs-forecast-date" class="quarto-xref">Figure&nbsp;8</a>). These dates span the rapid rise and fall of incident flu hospitalizations surrounding the season’s peak, with the largest differences in WIS occurring on November 28, December 5, December 12, January 2, and January 9. Additionally, the PI coverage rates for the linear pools were at least as large as the coverage rates of the other models throughout the entire period of analysis at both the 1 and 4 week ahead forecast horizons (see <a href="#fig-cov95-vs-forecast-date" class="quarto-xref">Figure&nbsp;9</a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-mae-vs-forecast-date" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mae-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-mae-vs-forecast-date-1.png" class="img-fluid figure-img" width="6000">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mae-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Average h-week ahead MAE by forecast date for each model for all locations (except the US national location), split by season for readability. Average target data across all locations is plotted in black.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-wis-vs-forecast-date" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wis-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-wis-vs-forecast-date-1.png" class="img-fluid figure-img" width="6000">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wis-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Average h-week ahead WIS by forecast date for each model for all locations (except the US national location), split by season for readability. Average target data across all locations is plotted in black.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-cov95-vs-forecast-date" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cov95-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hubEnsembles_manuscript_files/figure-html/fig-cov95-vs-forecast-date-1.png" class="img-fluid figure-img" width="5400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cov95-vs-forecast-date-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Target data and average h-week ahead 95% PI coverage by forecast date for each model for all locations (except the US national location), split by season for readability.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From these results, we can see that different ensembling methods perform best under different circumstances, though in this analysis all of the ensemble variations outperformed the baseline model. While the quantile median had the best overall results for WIS, MAE, 50% PI coverage, and 95% PI coverage, other models may perform better from week-to-week for each metric. Around the 2022-2023 season’s peak in early December, the remaining four models (including the baseline) each had instances in which they achieved the lowest WIS, like the linear pools for the one week ahead horizon for several weeks during this period.</p>
<p>The choice of an appropriate ensemble aggregation method may depend on the forecast target, the goal of forecasting, and the behavior of the individual models contributing to an ensemble. One case may call for prioritizing above-nominal coverage rates while another may prioritize accurate point forecasts. The <code>simple_ensemble</code> and <code>linear_pool</code> functions and the ability to specify component model weights and an aggregation function for <code>simple_ensemble</code> allow users to implement a variety of ensemble methods.</p>
</section>
<section id="sec-conclusions" class="level1">
<h1>Conclusion</h1>
<p>Ensembles of independent models are a powerful tool to generate more accurate and more reliable forecasts of future outcomes than a single model alone. Here, we have demonstrated how to utilize <code>hubEnsembles</code>, a simple and flexible framework to combine individual model forecasts and create ensemble predictions. When using <code>hubEnsembles</code>, it is important to carefully choose an ensemble method that is well suited for the situation. Although there may not be a “best” method, matching the properties of a given ensemble method with the features of the component models will likely yield best results. For example, we showed for forecasts of seasonal influenza in the US, the quantile median ensemble performed best overall, but the linear pool method had advantages during periods of rapid change, when outlying component forecasts were likely more important. Notably, all ensemble methods outperformed the baseline model. These performance improvements from ensemble models motivate the use of a “hub-based” approach to prediction for infectious diseases and in other fields. Fitting within the larger suite of “hubverse” tools that support such efforts, the <code>hubEnsembles</code> package provides important software infrastructure for leveraging the power of multi-model ensembles.</p>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-aastveit2018" class="csl-entry" role="listitem">
Aastveit, Knut Are, James Mitchell, Francesco Ravazzolo, and Herman K. van Dijk. 2018. <span>“The Evolution of Forecast Density Combinations in Economics.”</span> Amsterdam; Rotterdam. <a href="https://www.econstor.eu/handle/10419/185588">https://www.econstor.eu/handle/10419/185588</a>.
</div>
<div id="ref-alley2019" class="csl-entry" role="listitem">
Alley, Richard B., Kerry A. Emanuel, and Fuqing Zhang. 2019. <span>“Advances in Weather Prediction.”</span> <em>Science</em> 363 (6425): 342–44. <a href="https://doi.org/10.1126/science.aav7274">https://doi.org/10.1126/science.aav7274</a>.
</div>
<div id="ref-borchering_public_2023" class="csl-entry" role="listitem">
Borchering, Rebecca K., Jessica M. Healy, Betsy L. Cadwell, Michael A. Johansson, Rachel B. Slayton, Megan Wallace, and Matthew Biggerstaff. 2023. <span>“Public Health Impact of the <span>U</span>.<span>S</span>. <span>Scenario</span> <span>Modeling</span> <span>Hub</span>.”</span> <em>Epidemics</em> 44 (September): 100705. <a href="https://doi.org/10.1016/j.epidem.2023.100705">https://doi.org/10.1016/j.epidem.2023.100705</a>.
</div>
<div id="ref-bosse_stackr_2023" class="csl-entry" role="listitem">
Bosse, Nikos, Yuling Yao, Sam Abbott, and Sebastian Funk. 2023. <em>Stackr: <span>Create</span> <span>Mixture</span> <span>Models</span> <span>From</span> <span>Predictive</span> <span>Samples</span></em>. <a href="http://epiforecasts.io/stackr/">http://epiforecasts.io/stackr/</a>.
</div>
<div id="ref-bracher_evaluating_2021" class="csl-entry" role="listitem">
Bracher, Johannes, Evan L. Ray, Tilmann Gneiting, and Nicholas G. Reich. 2021. <span>“Evaluating Epidemic Forecasts in an Interval Format.”</span> <em>PLOS Computational Biology</em> 17 (2): e1008618. <a href="https://doi.org/10.1371/journal.pcbi.1008618">https://doi.org/10.1371/journal.pcbi.1008618</a>.
</div>
<div id="ref-cdc_flusight" class="csl-entry" role="listitem">
CDC. 2023. <span>“About Flu Forecasting.”</span> <a href="https://www.cdc.gov/flu/weekly/flusight/how-flu-forecasting.htm">https://www.cdc.gov/flu/weekly/flusight/how-flu-forecasting.htm</a>.
</div>
<div id="ref-clemen1989" class="csl-entry" role="listitem">
Clemen, Robert T. 1989. <span>“Combining Forecasts: A Review and Annotated Bibliography.”</span> <em>International Journal of Forecasting</em> 5 (4): 559–83. <a href="https://doi.org/10.1016/0169-2070(89)90012-5">https://doi.org/10.1016/0169-2070(89)90012-5</a>.
</div>
<div id="ref-colon-gonzalez_probabilistic_2021" class="csl-entry" role="listitem">
Colón-González, Felipe J., Leonardo Soares Bastos, Barbara Hofmann, Alison Hopkin, Quillon Harpham, Tom Crocker, Rosanna Amato, et al. 2021. <span>“Probabilistic Seasonal Dengue Forecasting in <span>Vietnam</span>: <span>A</span> Modelling Study Using Superensembles.”</span> <em>PLOS Medicine</em> 18 (3): e1003542. <a href="https://doi.org/10.1371/journal.pmed.1003542">https://doi.org/10.1371/journal.pmed.1003542</a>.
</div>
<div id="ref-couch_stacks_2023" class="csl-entry" role="listitem">
Couch, Simon, and Max Kuhn. 2023. <em>Stacks: Tidy Model Stacking</em>. <a href="https://stacks.tidymodels.org/">https://stacks.tidymodels.org/</a>.
</div>
<div id="ref-cramer2022" class="csl-entry" role="listitem">
Cramer, Estee Y., Evan L. Ray, Velma K. Lopez, Johannes Bracher, Andrea Brennen, Alvaro J. Castro Rivadeneira, Aaron Gerding, et al. 2022. <span>“Evaluation of Individual and Ensemble Probabilistic Forecasts of COVID-19 Mortality in the United States.”</span> <em>Proceedings of the National Academy of Sciences</em> 119 (15): e2113561119. <a href="https://doi.org/10.1073/pnas.2113561119">https://doi.org/10.1073/pnas.2113561119</a>.
</div>
<div id="ref-hibon2005" class="csl-entry" role="listitem">
Hibon, Michèle, and Theodoros Evgeniou. 2005. <span>“To Combine or Not to Combine: Selecting Among Forecasts and Their Combinations.”</span> <em>International Journal of Forecasting</em> 21 (1): 15–24. <a href="https://doi.org/10.1016/j.ijforecast.2004.05.002">https://doi.org/10.1016/j.ijforecast.2004.05.002</a>.
</div>
<div id="ref-howerton2023" class="csl-entry" role="listitem">
Howerton, Emily, Michael C. Runge, Tiffany L. Bogich, Rebecca K. Borchering, Hidetoshi Inamine, Justin Lessler, Luke C. Mullany, et al. 2023. <span>“Context-Dependent Representation of Within- and Between-Model Uncertainty: Aggregating Probabilistic Predictions in Infectious Disease Epidemiology.”</span> <em>Journal of The Royal Society Interface</em> 20 (198): 20220659. <a href="https://doi.org/10.1098/rsif.2022.0659">https://doi.org/10.1098/rsif.2022.0659</a>.
</div>
<div id="ref-hubverse_docs" class="csl-entry" role="listitem">
hubverse. 2022. <span>“The Hubverse: Open Tools for Collaborative Forecasting.”</span> <a href="https://hubdocs.readthedocs.io/en/latest/index.html">https://hubdocs.readthedocs.io/en/latest/index.html</a>.
</div>
<div id="ref-johansson2019" class="csl-entry" role="listitem">
Johansson, Michael A., Karyn M. Apfeldorf, Scott Dobson, Jason Devita, Anna L. Buczak, Benjamin Baugher, Linda J. Moniz, et al. 2019. <span>“An open challenge to advance probabilistic forecasting for dengue epidemics.”</span> <em>Proceedings of the National Academy of Sciences</em> 116 (48): 24268–74. <a href="https://doi.org/10.1073/pnas.1909865116">https://doi.org/10.1073/pnas.1909865116</a>.
</div>
<div id="ref-lichtendahl2013" class="csl-entry" role="listitem">
Lichtendahl, Kenneth C., Yael Grushka-Cockayne, and Robert L. Winkler. 2013. <span>“Is It Better to Average Probabilities or Quantiles?”</span> <em>Management Science</em> 59 (7): 1594–1611. <a href="https://doi.org/10.1287/mnsc.1120.1667">https://doi.org/10.1287/mnsc.1120.1667</a>.
</div>
<div id="ref-mcgowan2019" class="csl-entry" role="listitem">
McGowan, Craig J., Matthew Biggerstaff, Michael Johansson, Karyn M. Apfeldorf, Michal Ben-Nun, Logan Brooks, Matteo Convertino, et al. 2019. <span>“Collaborative Efforts to Forecast Seasonal Influenza in the United States, 2015<span></span>2016.”</span> <em>Scientific Reports</em> 9 (1): 683. <a href="https://doi.org/10.1038/s41598-018-36361-9">https://doi.org/10.1038/s41598-018-36361-9</a>.
</div>
<div id="ref-niederreiter1992quasirandom" class="csl-entry" role="listitem">
Niederreiter, Harald. 1992. <em>Random Number Generation and Quasi-Monte Carlo Methods</em>. Philadelphia PA: Society for Industrial; Applied Mathematics.
</div>
<div id="ref-paireau_ensemble_2022" class="csl-entry" role="listitem">
Paireau, Juliette, Alessio Andronico, Nathanaël Hozé, Maylis Layan, Pascal Crépey, Alix Roumagnac, Marc Lavielle, Pierre-Yves Boëlle, and Simon Cauchemez. 2022. <span>“An Ensemble Model Based on Early Predictors to Forecast <span>COVID</span>-19 Health Care Demand in <span>France</span>.”</span> <em>Proceedings of the National Academy of Sciences</em> 119 (18): e2103302119. <a href="https://doi.org/10.1073/pnas.2103302119">https://doi.org/10.1073/pnas.2103302119</a>.
</div>
<div id="ref-pedregosa_scikit-learn_2011" class="csl-entry" role="listitem">
Pedregosa, Fabian, Gaël Varoquaux, Alexandre Gramfort, Vincent Michel, Bertrand Thirion, Olivier Grisel, Mathieu Blondel, et al. 2011. <span>“Scikit-Learn: <span>Machine</span> <span>Learning</span> in <span>Python</span>.”</span> <em>Journal of Machine Learning Research</em> 12 (85): 2825–30. <a href="http://jmlr.org/papers/v12/pedregosa11a.html">http://jmlr.org/papers/v12/pedregosa11a.html</a>.
</div>
<div id="ref-ray_comparing_2023" class="csl-entry" role="listitem">
Ray, Evan L., Logan C. Brooks, Jacob Bien, Matthew Biggerstaff, Nikos I. Bosse, Johannes Bracher, Estee Y. Cramer, et al. 2023. <span>“Comparing Trained and Untrained Probabilistic Ensemble Forecasts of <span>COVID</span>-19 Cases and Deaths in the <span>United</span> <span>States</span>.”</span> <em>International Journal of Forecasting</em> 39 (3): 1366–83. <a href="https://doi.org/10.1016/j.ijforecast.2022.06.005">https://doi.org/10.1016/j.ijforecast.2022.06.005</a>.
</div>
<div id="ref-distfromq" class="csl-entry" role="listitem">
Ray, Evan L., and Aaron Gerding. 2024. <span>“Distfromq: Reconstruct a Distribution from a Collection of Quantiles.”</span> <a href="http://reichlab.io/distfromq/">http://reichlab.io/distfromq/</a>.
</div>
<div id="ref-ray_prediction_2018" class="csl-entry" role="listitem">
Ray, Evan L., and Nicholas G. Reich. 2018. <span>“Prediction of Infectious Disease Epidemics via Weighted Density Ensembles.”</span> <em>PLoS Computational Biology</em> 14 (2): e1005910. <a href="https://doi.org/10.1371/journal.pcbi.1005910">https://doi.org/10.1371/journal.pcbi.1005910</a>.
</div>
<div id="ref-reich2022" class="csl-entry" role="listitem">
Reich, Nicholas G., Justin Lessler, Sebastian Funk, Cecile Viboud, Alessandro Vespignani, Ryan J. Tibshirani, Katriona Shea, et al. 2022. <span>“Collaborative Hubs: Making the Most of Predictive Epidemic Modeling.”</span> <em>American Journal of Public Health</em> 112 (6): 839–42. <a href="https://doi.org/10.2105/AJPH.2022.306831">https://doi.org/10.2105/AJPH.2022.306831</a>.
</div>
<div id="ref-reich_accuracy_2019" class="csl-entry" role="listitem">
Reich, Nicholas G., Craig J. McGowan, Teresa K. Yamana, Abhinav Tushar, Evan L. Ray, Dave Osthus, Sasikiran Kandula, et al. 2019. <span>“Accuracy of Real-Time Multi-Model Ensemble Forecasts for Seasonal Influenza in the <span>U</span>.<span>S</span>.”</span> <em>PLoS Computational Biology</em> 15 (11): e1007486. <a href="https://doi.org/10.1371/journal.pcbi.1007486">https://doi.org/10.1371/journal.pcbi.1007486</a>.
</div>
<div id="ref-stone1961" class="csl-entry" role="listitem">
Stone, M. 1961. <span>“The Opinion Pool.”</span> <em>The Annals of Mathematical Statistics</em> 32 (4): 1339–42. <a href="http://www.jstor.org/stable/2237933">http://www.jstor.org/stable/2237933</a>.
</div>
<div id="ref-tebaldi2007" class="csl-entry" role="listitem">
Tebaldi, Claudia, and Reto Knutti. 2007. <span>“The Use of the Multi-Model Ensemble in Probabilistic Climate Projections.”</span> <em>Philosophical Transactions: Mathematical, Physical and Engineering Sciences</em> 365 (1857): 2053–75. <a href="https://doi.org/10.1098/rsta.2007.2076">https://doi.org/10.1098/rsta.2007.2076</a>.
</div>
<div id="ref-timmermann2006b" class="csl-entry" role="listitem">
Timmermann, Allan. 2006. <span>“Chapter 4 Forecast Combinations.”</span> In, edited by G. Elliott, C. W. J. Granger, and A. Timmermann, 1:135–96. Elsevier. <a href="https://doi.org/10.1016/S1574-0706(05)01004-9">https://doi.org/10.1016/S1574-0706(05)01004-9</a>.
</div>
<div id="ref-viboud2018" class="csl-entry" role="listitem">
Viboud, Cécile, Kaiyuan Sun, Robert Gaffey, Marco Ajelli, Laura Fumanelli, Stefano Merler, Qian Zhang, Gerardo Chowell, Lone Simonsen, and Alessandro Vespignani. 2018. <span>“The RAPIDD Ebola Forecasting Challenge: Synthesis and Lessons Learnt.”</span> <em>Epidemics</em>, The RAPIDD Ebola Forecasting Challenge, 22 (March): 13–21. <a href="https://doi.org/10.1016/j.epidem.2017.08.002">https://doi.org/10.1016/j.epidem.2017.08.002</a>.
</div>
<div id="ref-vincent1912" class="csl-entry" role="listitem">
Vincent, Stella Burnham. 1912. <span>“The Function of the Vibrissae in the Behavior of the White Rat.”</span> PhD thesis, Cambridge MA.
</div>
<div id="ref-weiss2019" class="csl-entry" role="listitem">
Weiss, Christoph,E., Eran Raviv, and Gernot Roetzer. 2019. <span>“Forecast Combinations in R Using the ForecastComb Package.”</span> <em>The R Journal</em> 10 (2): 262. <a href="https://doi.org/10.32614/RJ-2018-052">https://doi.org/10.32614/RJ-2018-052</a>.
</div>
<div id="ref-winkler2015" class="csl-entry" role="listitem">
Winkler, Robert L. 2015. <span>“Equal Versus Differential Weighting in Combining Forecasts.”</span> <em>Risk Analysis</em> 35 (1): 16–18. <a href="https://doi.org/10.1111/risa.12302">https://doi.org/10.1111/risa.12302</a>.
</div>
<div id="ref-yamana_superensemble_2016" class="csl-entry" role="listitem">
Yamana, Teresa K., Sasikiran Kandula, and Jeffrey Shaman. 2016. <span>“Superensemble Forecasts of Dengue Outbreaks.”</span> <em>Journal of The Royal Society Interface</em> 13 (123): 20160410. <a href="https://doi.org/10.1098/rsif.2016.0410">https://doi.org/10.1098/rsif.2016.0410</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>